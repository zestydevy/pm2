#include <nusys.h>
#include <string.h>

#include "exception.hpp"

const u8 debug_font_width = 6;
const u8 debug_font_height = 8;
const u8 debug_font_char_per_line = 16;

static const u8 debug_font[] __attribute__((aligned(8))) = {
  0x00,0x10,0x6C,0x00,0x20,0x64,0x20,0x30,0x10,0x22,0x00,0x00,0x00,0x00,0x00,0x00, // ...........#.....##.##............#......##..#....#.......##.......#......#...#.................................................
  0x00,0x38,0x6C,0x28,0x38,0x64,0x50,0x30,0x20,0x10,0x28,0x10,0x00,0x00,0x00,0x04, // ..........###....##.##....#.#.....###....##..#...#.#......##......#........#......#.#......#.................................#..
  0x00,0x38,0x48,0x7C,0x40,0x08,0x50,0x20,0x20,0x10,0x38,0x10,0x00,0x00,0x00,0x08, // ..........###....#..#....#####...#..........#....#.#......#.......#........#......###......#................................#...
  0x00,0x10,0x00,0x28,0x30,0x10,0x20,0x00,0x20,0x10,0x7C,0x7C,0x00,0x7C,0x00,0x10, // ...........#..............#.#.....##.......#......#...............#........#.....#####...#####...........#####.............#....
  0x00,0x10,0x00,0x28,0x08,0x20,0x54,0x00,0x20,0x10,0x38,0x10,0x00,0x00,0x00,0x20, // ...........#..............#.#.......#.....#......#.#.#............#........#......###......#..............................#.....
  0x00,0x00,0x00,0x7C,0x70,0x4C,0x48,0x00,0x20,0x10,0x28,0x10,0x30,0x00,0x30,0x40, // .........................#####...###.....#..##...#..#.............#........#......#.#......#......##..............##.....#......
  0x00,0x10,0x00,0x28,0x10,0x4C,0x34,0x00,0x10,0x20,0x00,0x00,0x30,0x00,0x30,0x00, // ...........#..............#.#......#.....#..##....##.#.............#......#.......................##..............##............
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00, // ..................................................................................................#.............................
  0x38,0x10,0x38,0x38,0x08,0x7C,0x18,0x7C,0x38,0x38,0x00,0x00,0x08,0x00,0x20,0x38, // ..###......#......###.....###.......#....#####.....##....#####....###.....###.......................#.............#.......###...
  0x44,0x30,0x44,0x44,0x18,0x40,0x20,0x04,0x44,0x44,0x00,0x00,0x10,0x00,0x10,0x44, // .#...#....##.....#...#...#...#.....##....#........#..........#...#...#...#...#.....................#...............#.....#...#..
  0x4C,0x10,0x04,0x04,0x28,0x40,0x40,0x08,0x44,0x44,0x30,0x30,0x20,0x7C,0x08,0x04, // .#..##.....#.........#.......#....#.#....#.......#..........#....#...#...#...#....##......##......#......#####......#........#..
  0x54,0x10,0x18,0x38,0x48,0x78,0x78,0x10,0x38,0x3C,0x30,0x30,0x40,0x00,0x04,0x18, // .#.#.#.....#.......##.....###....#..#....####....####......#......###.....####....##......##.....#...................#.....##...
  0x64,0x10,0x20,0x04,0x7C,0x04,0x44,0x20,0x44,0x04,0x00,0x00,0x20,0x00,0x08,0x10, // .##..#.....#......#..........#...#####.......#...#...#....#......#...#.......#....................#.................#......#....
  0x44,0x10,0x40,0x44,0x08,0x44,0x44,0x20,0x44,0x08,0x30,0x30,0x10,0x7C,0x10,0x00, // .#...#.....#.....#.......#...#......#....#...#...#...#....#......#...#......#.....##......##.......#.....#####.....#............
  0x38,0x38,0x7C,0x38,0x08,0x38,0x38,0x20,0x38,0x30,0x30,0x30,0x08,0x00,0x20,0x10, // ..###.....###....#####....###.......#.....###.....###.....#.......###.....##......##......##........#.............#........#....
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00, // ..........................................................................................#.....................................
  0x38,0x38,0x78,0x38,0x78,0x7C,0x7C,0x38,0x44,0x38,0x04,0x44,0x40,0x44,0x44,0x38, // ..###.....###....####.....###....####....#####...#####....###....#...#....###........#...#...#...#.......#...#...#...#....###...
  0x44,0x44,0x44,0x44,0x44,0x40,0x40,0x44,0x44,0x10,0x04,0x48,0x40,0x6C,0x64,0x44, // .#...#...#...#...#...#...#...#...#...#...#.......#.......#...#...#...#.....#.........#...#..#....#.......##.##...##..#...#...#..
  0x5C,0x44,0x44,0x40,0x44,0x40,0x40,0x40,0x44,0x10,0x04,0x50,0x40,0x54,0x54,0x44, // .#.###...#...#...#...#...#.......#...#...#.......#.......#.......#...#.....#.........#...#.#.....#.......#.#.#...#.#.#...#...#..
  0x54,0x44,0x78,0x40,0x44,0x78,0x78,0x5C,0x7C,0x10,0x04,0x60,0x40,0x44,0x4C,0x44, // .#.#.#...#...#...####....#.......#...#...####....####....#.###...#####.....#.........#...##......#.......#...#...#..##...#...#..
  0x5C,0x7C,0x44,0x40,0x44,0x40,0x40,0x44,0x44,0x10,0x44,0x50,0x40,0x44,0x44,0x44, // .#.###...#####...#...#...#.......#...#...#.......#.......#...#...#...#.....#.....#...#...#.#.....#.......#...#...#...#...#...#..
  0x40,0x44,0x44,0x44,0x44,0x40,0x40,0x44,0x44,0x10,0x44,0x48,0x40,0x44,0x44,0x44, // .#.......#...#...#...#...#...#...#...#...#.......#.......#...#...#...#.....#.....#...#...#..#....#.......#...#...#...#...#...#..
  0x38,0x44,0x78,0x38,0x78,0x7C,0x40,0x3C,0x44,0x38,0x38,0x44,0x7C,0x44,0x44,0x38, // ..###....#...#...####.....###....####....#####...#........####...#...#....###.....###....#...#...#####...#...#...#...#....###...
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ................................................................................................................................
  0x78,0x38,0x78,0x38,0x7C,0x44,0x44,0x44,0x44,0x44,0x78,0x38,0x00,0x38,0x10,0x00, // .####.....###....####.....###....#####...#...#...#...#...#...#...#...#...#...#...####.....###.............###......#............
  0x44,0x44,0x44,0x44,0x10,0x44,0x44,0x44,0x44,0x44,0x08,0x20,0x40,0x08,0x28,0x00, // .#...#...#...#...#...#...#...#.....#.....#...#...#...#...#...#...#...#...#...#......#.....#......#..........#.....#.#...........
  0x44,0x44,0x44,0x40,0x10,0x44,0x44,0x54,0x28,0x44,0x10,0x20,0x20,0x08,0x44,0x00, // .#...#...#...#...#...#...#.........#.....#...#...#...#...#.#.#....#.#....#...#.....#......#.......#.........#....#...#..........
  0x78,0x44,0x78,0x38,0x10,0x44,0x44,0x54,0x10,0x28,0x20,0x20,0x10,0x08,0x00,0x00, // .####....#...#...####.....###......#.....#...#...#...#...#.#.#.....#......#.#.....#.......#........#........#...................
  0x40,0x54,0x48,0x04,0x10,0x44,0x44,0x54,0x28,0x10,0x40,0x20,0x08,0x08,0x00,0x00, // .#.......#.#.#...#..#........#.....#.....#...#...#...#...#.#.#....#.#......#.....#........#.........#.......#...................
  0x40,0x48,0x44,0x44,0x10,0x44,0x28,0x54,0x44,0x10,0x40,0x20,0x04,0x08,0x00,0x00, // .#.......#..#....#...#...#...#.....#.....#...#....#.#....#.#.#...#...#.....#.....#........#..........#......#...................
  0x40,0x34,0x44,0x38,0x10,0x38,0x10,0x28,0x44,0x10,0x78,0x38,0x00,0x38,0x00,0x00, // .#........##.#...#...#....###......#......###......#......#.#....#...#.....#.....####.....###.............###...................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC, // ........................................................................................................................######..
  0x30,0x00,0x40,0x00,0x04,0x00,0x18,0x00,0x40,0x10,0x08,0x40,0x10,0x00,0x00,0x00, // ..##.............#...................#.............##............#.........#........#....#.........#............................
  0x30,0x00,0x40,0x00,0x04,0x00,0x20,0x00,0x40,0x00,0x00,0x40,0x10,0x00,0x00,0x00, // ..##.............#...................#............#..............#.......................#.........#............................
  0x10,0x38,0x78,0x38,0x3C,0x38,0x20,0x3C,0x70,0x10,0x18,0x48,0x10,0x68,0x70,0x38, // ...#......###....####.....###.....####....###.....#.......####...###.......#.......##....#..#......#.....##.#....###......###...
  0x00,0x04,0x44,0x44,0x44,0x44,0x78,0x44,0x48,0x10,0x08,0x50,0x10,0x54,0x48,0x44, // .............#...#...#...#...#...#...#...#...#...####....#...#...#..#......#........#....#.#.......#.....#.#.#...#..#....#...#..
  0x00,0x3C,0x44,0x40,0x44,0x78,0x20,0x44,0x48,0x10,0x08,0x60,0x10,0x54,0x48,0x44, // ..........####...#...#...#.......#...#...####.....#......#...#...#..#......#........#....##........#.....#.#.#...#..#....#...#..
  0x00,0x44,0x44,0x44,0x44,0x40,0x20,0x3C,0x48,0x10,0x08,0x50,0x10,0x44,0x48,0x44, // .........#...#...#...#...#...#...#...#...#........#.......####...#..#......#........#....#.#.......#.....#...#...#..#....#...#..
  0x00,0x3C,0x78,0x38,0x3C,0x38,0x20,0x04,0x48,0x18,0x48,0x48,0x18,0x44,0x48,0x38, // ..........####...####.....###.....####....###.....#..........#...#..#......##....#..#....#..#......##....#...#...#..#.....###...
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00, // ..........................................................###.....................##............................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x10,0x30,0x28,0x10, // ...........................................................................................##......#......##......#.#......#....
  0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x10,0x08,0x50,0x38, // ..................................#.......................................................#........#........#....#.#......###...
  0x78,0x3C,0x58,0x38,0x78,0x48,0x44,0x44,0x48,0x48,0x78,0x20,0x10,0x08,0x00,0x6C, // .####.....####...#.##.....###....####....#..#....#...#...#...#...#..#....#..#....####.....#........#........#............##.##..
  0x44,0x44,0x24,0x40,0x20,0x48,0x44,0x44,0x48,0x48,0x08,0x60,0x00,0x0C,0x00,0x44, // .#...#...#...#....#..#...#........#......#..#....#...#...#...#...#..#....#..#.......#....##.................##...........#...#..
  0x44,0x44,0x20,0x38,0x20,0x48,0x44,0x54,0x30,0x48,0x30,0x20,0x10,0x08,0x00,0x44, // .#...#...#...#....#.......###.....#......#..#....#...#...#.#.#....##.....#..#.....##......#........#........#............#...#..
  0x44,0x44,0x20,0x04,0x28,0x58,0x28,0x7C,0x48,0x38,0x40,0x20,0x10,0x08,0x00,0x7C, // .#...#...#...#....#..........#....#.#....#.##.....#.#....#####...#..#.....###....#........#........#........#............#####..
  0x78,0x3C,0x70,0x38,0x10,0x28,0x10,0x28,0x48,0x10,0x78,0x18,0x10,0x30,0x00,0x00, // .####.....####...###......###......#......#.#......#......#.#....#..#......#.....####......##......#......##....................
  0x40,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x02,0x00,0x00,0x00  // .#...........#...........................................................##...........................#.........................
};

const reg_desc causeDesc[] = {
    {CAUSE_BD,      CAUSE_BD,    const_cast<char *>("BD")},
    {CAUSE_IP8,     CAUSE_IP8,   const_cast<char *>("IP8")},
    {CAUSE_IP7,     CAUSE_IP7,   const_cast<char *>("IP7")},
    {CAUSE_IP6,     CAUSE_IP6,   const_cast<char *>("IP6")},
    {CAUSE_IP5,     CAUSE_IP5,   const_cast<char *>("IP5")},
    {CAUSE_IP4,     CAUSE_IP4,   const_cast<char *>("IP4")},
    {CAUSE_IP3,     CAUSE_IP3,   const_cast<char *>("IP3")},
    {CAUSE_SW2,     CAUSE_SW2,   const_cast<char *>("IP2")},
    {CAUSE_SW1,     CAUSE_SW1,   const_cast<char *>("IP1")},
    {CAUSE_EXCMASK, EXC_INT,     const_cast<char *>("Interrupt")},
    {CAUSE_EXCMASK, EXC_MOD,     const_cast<char *>("TLB modification exception")},
    {CAUSE_EXCMASK, EXC_RMISS,   const_cast<char *>("TLB on load or instruction")},
    {CAUSE_EXCMASK, EXC_WMISS,   const_cast<char *>("TLB on store")},
    {CAUSE_EXCMASK, EXC_RADE,    const_cast<char *>("Addr err on load or instruction")},
    {CAUSE_EXCMASK, EXC_WADE,    const_cast<char *>("Addr err on store")},
    {CAUSE_EXCMASK, EXC_IBE,     const_cast<char *>("Bus err on instruction fetch")},
    {CAUSE_EXCMASK, EXC_DBE,     const_cast<char *>("Bus err on data reference")},
    {CAUSE_EXCMASK, EXC_SYSCALL, const_cast<char *>("System call exception")},
    {CAUSE_EXCMASK, EXC_BREAK,   const_cast<char *>("Breakpoint exception")},
    {CAUSE_EXCMASK, EXC_II,      const_cast<char *>("Reserved instruction")},
    {CAUSE_EXCMASK, EXC_CPU,     const_cast<char *>("Coprocessor unusable")},
    {CAUSE_EXCMASK, EXC_OV,      const_cast<char *>("Arithmetic overflow")},
    {CAUSE_EXCMASK, EXC_TRAP,    const_cast<char *>("Trap exception")},
    {CAUSE_EXCMASK, EXC_VCEI,    const_cast<char *>("Virtual coherency on intruction")},
    {CAUSE_EXCMASK, EXC_FPE,     const_cast<char *>("Floating point exception")},
    {CAUSE_EXCMASK, EXC_WATCH,   const_cast<char *>("Watchpoint exception")},
    {CAUSE_EXCMASK, EXC_VCED,    const_cast<char *>("Virtual coherency on data reference")},
    {0,             0,           const_cast<char *>("")}
    };

const reg_desc srDesc[] = {
    {SR_CU3,      SR_CU3,     const_cast<char *>("CU3")},
    {SR_CU2,      SR_CU2,     const_cast<char *>("CU2")},
    {SR_CU1,      SR_CU1,     const_cast<char *>("CU1")},
    {SR_CU0,      SR_CU0,     const_cast<char *>("CU0")},
    {SR_RP,       SR_RP,      const_cast<char *>("RP")},
    {SR_FR,       SR_FR,      const_cast<char *>("FR")},
    {SR_RE,       SR_RE,      const_cast<char *>("RE")},
    {SR_BEV,      SR_BEV,     const_cast<char *>("BEV")},
    {SR_TS,       SR_TS,      const_cast<char *>("TS")},
    {SR_SR,       SR_SR,      const_cast<char *>("SR")},
    {SR_CH,       SR_CH,      const_cast<char *>("CH")},
    {SR_CE,       SR_CE,      const_cast<char *>("CE")},
    {SR_DE,       SR_DE,      const_cast<char *>("DE")},
    {SR_IBIT8,    SR_IBIT8,   const_cast<char *>("IM8")},
    {SR_IBIT7,    SR_IBIT7,   const_cast<char *>("IM7")},
    {SR_IBIT6,    SR_IBIT6,   const_cast<char *>("IM6")},
    {SR_IBIT5,    SR_IBIT5,   const_cast<char *>("IM5")},
    {SR_IBIT4,    SR_IBIT4,   const_cast<char *>("IM4")},
    {SR_IBIT3,    SR_IBIT3,   const_cast<char *>("IM3")},
    {SR_IBIT2,    SR_IBIT2,   const_cast<char *>("IM2")},
    {SR_IBIT1,    SR_IBIT1,   const_cast<char *>("IM1")},
    {SR_KX,       SR_KX,      const_cast<char *>("KX")},
    {SR_SX,       SR_SX,      const_cast<char *>("SX")},
    {SR_UX,       SR_UX,      const_cast<char *>("UX")},
    {SR_KSU_MASK, SR_KSU_USR, const_cast<char *>("USR")},
    {SR_KSU_MASK, SR_KSU_SUP, const_cast<char *>("SUP")},
    {SR_KSU_MASK, SR_KSU_KER, const_cast<char *>("KER")},
    {SR_ERL,      SR_ERL,     const_cast<char *>("ERL")},
    {SR_EXL,      SR_EXL,     const_cast<char *>("EXL")},
    {SR_IE,       SR_IE,      const_cast<char *>("IE")},
    {0,           0,          const_cast<char *>("")}
};

const reg_desc fpcsrDesc[] = {
    {FPCSR_FS,      FPCSR_FS,    const_cast<char *>("FS")},
    {FPCSR_C,       FPCSR_C,     const_cast<char *>("C")},
    {FPCSR_CE,      FPCSR_CE,    const_cast<char *>("Unimplemented operation")},
    {FPCSR_CV,      FPCSR_CV,    const_cast<char *>("Invalid operation")},
    {FPCSR_CZ,      FPCSR_CZ,    const_cast<char *>("Division by zero")},
    {FPCSR_CO,      FPCSR_CO,    const_cast<char *>("Overflow")},
    {FPCSR_CU,      FPCSR_CU,    const_cast<char *>("Underflow")},
    {FPCSR_CI,      FPCSR_CI,    const_cast<char *>("Inexact operation")},
    {FPCSR_EV,      FPCSR_EV,    const_cast<char *>("EV")},
    {FPCSR_EZ,      FPCSR_EZ,    const_cast<char *>("EZ")},
    {FPCSR_EO,      FPCSR_EO,    const_cast<char *>("EO")},
    {FPCSR_EU,      FPCSR_EU,    const_cast<char *>("EU")},
    {FPCSR_EI,      FPCSR_EI,    const_cast<char *>("EI")},
    {FPCSR_FV,      FPCSR_FV,    const_cast<char *>("FV")},
    {FPCSR_FZ,      FPCSR_FZ,    const_cast<char *>("FZ")},
    {FPCSR_FO,      FPCSR_FO,    const_cast<char *>("FO")},
    {FPCSR_FU,      FPCSR_FU,    const_cast<char *>("FU")},
    {FPCSR_FI,      FPCSR_FI,    const_cast<char *>("FI")},
    {FPCSR_RM_MASK, FPCSR_RM_RN, const_cast<char *>("RN")},
    {FPCSR_RM_MASK, FPCSR_RM_RZ, const_cast<char *>("RZ")},
    {FPCSR_RM_MASK, FPCSR_RM_RP, const_cast<char *>("RP")},
    {FPCSR_RM_MASK, FPCSR_RM_RM, const_cast<char *>("RM")},
    {0,             0,           const_cast<char *>("")}
};

void debug_draw_char(u16* buffer, u32 x, u32 y, char c) {
    u8 index = (u8)c - 32;
    u32 xOffset = (index % debug_font_char_per_line);
    u32 yOffset = (index / debug_font_char_per_line) * debug_font_char_per_line * debug_font_height;

    u32 offset = xOffset + yOffset;
    u32 fbX = x; u32 fbY = y;

    for(int i = 0; i < debug_font_height; i++) {
        u8 pixel = debug_font[offset + (debug_font_char_per_line * i)];
        for(int j = 0; j < 6; j++) {
            buffer[320 + (fbY * 320) + fbX] = pixel & (0x80 >> j) ? 0xFFFF : 0x0001;
            fbX++;
        }
        fbX = x;
        fbY++;
    }
}

void debug_draw_string(u16* buffer, u32 x, u32 y, char* message) {
    size_t size = strlen(message);
    for(size_t i = 0; i < size; i++) {
        char c = message[i];
        debug_draw_char(buffer, x + (i * debug_font_width), y, c);
    }

}

void debug_printreg(u16* buffer, u32 x, u32 y, u32 value, char *name, reg_desc *desc) {
    char first = 1;
    char str[128];
    char* cause;

    while(desc->mask != 0) {
        if((value & desc->mask) == desc->value) {
            cause = desc->string;
        }
        desc++;
    }

    sprintf(str, "%s | %08x | %s", name, (u8)value, cause);
    debug_draw_string(buffer, x, y, str);
}
